<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìŠ¤ë§ˆíŠ¸ êµí†µ í—ˆë¸Œ</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c4efd9618689d77a19905c8996d3fe3f&libraries=services"></script>
<style>
    :root { --primary: #00d2ff; --sub: #007bff; --accent: #ff9f43; }
    body { font-family: 'Pretendard', sans-serif; padding: 0; margin: 0; background: #f4f7f6; color: #333; }
    .header-nav { background: #fff; padding: 15px; display: flex; align-items: center; border-bottom: 1px solid #ddd; position: sticky; top:0; z-index:100; }
    .header-nav a { text-decoration: none; color: var(--sub); font-weight: bold; border: 1px solid var(--sub); padding: 4px 10px; border-radius: 5px; }
    
    #map { width: 100%; height: 350px; background: #eee; border-bottom: 2px solid var(--primary); display: block; }
    
    .controls { padding: 20px; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    select, .search-btn { width: 100%; padding: 15px; border-radius: 10px; border: 1px solid #ddd; font-size: 1rem; }
    .search-btn { background: var(--primary); color: white; border: none; font-weight: bold; margin-top: 10px; cursor: pointer; }
    
    #resultList { padding: 10px; }
    .result-card { background: white; padding: 18px; border-radius: 15px; margin-bottom: 12px; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
    .result-card h4 { margin: 0 0 5px 0; color: #222; }
    .result-card p { margin: 0; font-size: 0.85rem; color: #777; }
    
    .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
    .action-btn { text-align: center; padding: 10px; border-radius: 8px; font-size: 0.85rem; font-weight: bold; text-decoration: none; border: 1px solid #ddd; }
    .btn-sch { background: #fff4e6; color: #d35400; border-color: #ffd8a8; cursor: pointer; }
    .btn-res { background: #eafaf1; color: #27ae60; border-color: #abebc6; }

    /* ì‹œê°„í‘œ ì¶œë ¥ í…Œì´ë¸” ìŠ¤íƒ€ì¼ ì¶”ê°€ */
    .schedule-table { width: 100%; margin-top: 15px; border-top: 2px solid #eee; font-size: 0.8rem; border-collapse: collapse; }
    .schedule-table th { background: #f9f9f9; padding: 8px; border-bottom: 1px solid #ddd; }
    .schedule-table td { padding: 8px; border-bottom: 1px solid #f1f1f1; text-align: center; }
</style>
</head>
<body>
<div class="header-nav"><a href="index.html">ğŸ  í¬í„¸ë¡œ</a><span style="margin-left:15px; font-weight:bold;">ìŠ¤ë§ˆíŠ¸ êµí†µ í—ˆë¸Œ</span></div>

<div id="map"></div>

<div class="controls">
    <select id="radius">
        <option value="5000">5km ì´ë‚´</option>
        <option value="10000" selected>10km ì´ë‚´</option>
        <option value="20000">20km ì´ë‚´</option>
    </select>
    <button class="search-btn" onclick="searchHubs()">ì£¼ë³€ ì—­/í„°ë¯¸ë„ ê²€ìƒ‰í•˜ê¸°</button>
</div>

<div id="resultList"></div>

<script>
let map, ps, myPos;
let markers = [];
const SERVER_IP = "192.168.0.50";

function initMap() {
    const container = document.getElementById('map');
    navigator.geolocation.getCurrentPosition(pos => {
        myPos = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
        const options = { center: myPos, level: 7 };
        map = new kakao.maps.Map(container, options);
        ps = new kakao.maps.services.Places();
        new kakao.maps.Marker({
            position: myPos, map: map,
            image: new kakao.maps.MarkerImage('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png', new kakao.maps.Size(24, 35))
        });
    }, () => {
        myPos = new kakao.maps.LatLng(35.247, 128.651);
        map = new kakao.maps.Map(container, { center: myPos, level: 7 });
        ps = new kakao.maps.services.Places();
    });
}

kakao.maps.load(initMap);

function searchHubs() {
    if(!ps) return alert("ì§€ë„ê°€ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤.");
    const radius = document.getElementById('radius').value;
    const keywords = ['ê¸°ì°¨ì—­', 'ë²„ìŠ¤í„°ë¯¸ë„'];
    const exclude = ['í™”ë¬¼', 'íì—­', 'ë¬¼ë¥˜', 'ê²€ìˆ˜'];
    
    document.getElementById('resultList').innerHTML = "";
    markers.forEach(m => m.setMap(null)); markers = [];

    keywords.forEach(kw => {
        ps.keywordSearch(kw, (data, status) => {
            if (status === kakao.maps.services.Status.OK) {
                const filtered = data.filter(p => !exclude.some(word => p.place_name.includes(word)));
                filtered.forEach(p => {
                    const isTrain = p.place_name.endsWith('ì—­');
                    const resLink = isTrain ? "https://www.letskorail.com/" : "https://txbus.t-money.co.kr/";
                    const marker = new kakao.maps.Marker({ position: new kakao.maps.LatLng(p.y, p.x), map: map });
                    markers.push(marker);

                    const cardId = `sch-${p.place_name.replace(/ /g,'')}`;
                    document.getElementById('resultList').innerHTML += `
                        <div class="result-card">
                            <h4>${p.place_name}</h4>
                            <p>${p.address_name} (ì•½ ${p.distance}m)</p>
                            <div class="btn-group">
                                <a onclick="viewSchedule('${p.place_name}')" class="action-btn btn-sch">ğŸ“… ì‹œê°„í‘œ</a>
                                <a href="${resLink}" target="_blank" class="action-btn btn-res">ğŸ« ì˜ˆë§¤</a>
                            </div>
                            <div id="${cardId}" style="display:none;"></div>
                        </div>`;
                });
            }
        }, { location: myPos, radius: radius, sort: kakao.maps.services.SortBy.DISTANCE });
    });
}

async function viewSchedule(name) {
    const displayDiv = document.getElementById(`sch-${name.replace(/ /g,'')}`);
    displayDiv.style.display = "block";
    displayDiv.innerHTML = "<p style='text-align:center; font-size:12px;'>ì¡°íšŒ ì¤‘...</p>";

    try {
        const res = await fetch(`http://${SERVER_IP}:5000/api/timetable/${encodeURIComponent(name)}`);
        const data = await res.json();
        
        if(data.length === 0) {
            displayDiv.innerHTML = "<p style='text-align:center; font-size:12px;'>ê²€ìƒ‰ëœ ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
            return;
        }

        let html = '<table class="schedule-table"><tr><th>ì‹œê°„</th><th>ëª©ì ì§€</th><th>ì¢…ë¥˜</th></tr>';
        data.forEach(item => {
            html += `<tr><td>${item.time}</td><td>${item.dest}</td><td>${item.type}</td></tr>`;
        });
        html += '</table>';
        displayDiv.innerHTML = html;
    } catch(e) {
        displayDiv.innerHTML = "<p style='text-align:center; color:red; font-size:12px;'>ì„œë²„ ì—°ê²° ì‹¤íŒ¨</p>";
    }
}
</script>
</body>
</html>
