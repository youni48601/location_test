<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë™ ìë™ í•„í„° ì‹œìŠ¤í…œ V2 FINAL</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c4efd9618689d77a19905c8996d3fe3f&libraries=services"></script>
<style>
    :root { --primary: #00d2ff; --sub: #007bff; --bg: #f4f7f6; }
    body { font-family: 'Pretendard', sans-serif; padding: 0; margin: 0; background: var(--bg); color: #333; }
    .header-nav { background: #fff; padding: 15px; display: flex; align-items: center; border-bottom: 1px solid #ddd; position: sticky; top:0; z-index:100; }
    .header-nav a { text-decoration: none; color: var(--sub); font-weight: bold; border: 1px solid var(--sub); padding: 4px 10px; border-radius: 5px; }
    .main-container { padding: 15px; }
    .tabs { display: flex; margin-bottom: 15px; background: #eee; border-radius: 10px; padding: 5px; }
    .tab-button { flex: 1; padding: 12px; border: none; background: none; cursor: pointer; border-radius: 8px; font-weight: bold; color: #666; }
    .tab-button.active { background: white; color: var(--sub); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .mapWrap { position: relative; border-radius: 15px; overflow: hidden; border: 1px solid #ddd; margin-bottom: 15px; height: 350px; background: #fff; }
    #map { width: 100%; height: 100%; }
    .mapBtn { position: absolute; z-index: 5; top: 10px; right: 10px; background: white; padding: 6px; border: 1px solid #aaa; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold; }
    textarea { width: 100%; height: 120px; border-radius: 10px; border: 1px solid #ddd; padding: 10px; box-sizing: border-box; font-size: 14px; }
    select, .main-btn { width: 100%; padding: 15px; margin-top: 10px; border-radius: 10px; border: 1px solid #ddd; font-size: 1rem; }
    .main-btn { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
    .copy-btn { background: #6c757d; margin-top: 5px; }
    .box { border: 1px solid #ddd; padding: 15px; margin-top: 10px; border-radius: 12px; background: white; min-height: 50px; word-break: break-all; font-size: 14px; }
    .group-container { background: white; border: 1px solid #eee; border-radius: 12px; padding: 10px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .groupHeader { display: flex; align-items: center; gap: 8px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0; margin-bottom: 10px; font-weight: bold; color: var(--sub); }
    .row { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; padding: 5px; }
    .row input[type=number] { width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 5px; }
    .card { border: 1px solid #eee; padding: 10px; margin-bottom: 8px; border-radius: 10px; background: white; font-size: 0.9rem; }
</style>
</head>
<body>
<div class="header-nav"><a href="index.html">ğŸ  í¬í„¸ë¡œ</a><span style="margin-left:15px; font-weight:bold;">ë™ ìë™ í•„í„° ì‹œìŠ¤í…œ V2</span></div>
<div class="main-container">
    <div class="tabs">
        <button class="tab-button active" onclick="tab(event,'search')">ê²€ìƒ‰</button>
        <button class="tab-button" onclick="tab(event,'accept')">ìˆ˜ë½</button>
        <button class="tab-button" onclick="tab(event,'exclude')">ì œì™¸</button>
    </div>

    <div id="search" class="tab-content">
        <div class="mapWrap">
            <div id="map"></div>
            <div class="mapBtn" onclick="goMyLocation()">ë‚´ ìœ„ì¹˜ë¡œ</div>
        </div>
        <select id="radius">
            <option value="1">1km ì´ë‚´</option>
            <option value="2">2km ì´ë‚´</option>
            <option value="5" selected>5km ì´ë‚´</option>
            <option value="10">10km ì´ë‚´</option>
            <option value="20">20km ì´ë‚´</option>
            <option value="50">50km ì´ë‚´</option>
        </select>
        <button class="main-btn" onclick="findDongs()">ë°˜ê²½ ë‚´ ë™ ê²€ìƒ‰í•˜ê¸°</button>
        <button class="main-btn copy-btn" onclick="copySearch()">ê²°ê³¼ ì „ì²´ ë³µì‚¬</button>
        <div id="searchResult" style="margin-top:15px;"></div>
    </div>

    <div id="accept" class="tab-content" style="display:none;">
        <textarea id="acceptText" placeholder="ì—¬ê¸°ì— ì£¼ì†Œ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
        <button class="main-btn" onclick="extractAccept()">ë™ ì´ë¦„ ì¶”ì¶œ</button>
        <div id="acceptList" style="margin-top:15px;"></div>
        <button class="main-btn" style="background:var(--sub);" onclick="makeFinal()">ìµœì¢… ê²°ê³¼ ìƒì„± (#)</button>
        <div id="finalBox" class="box"></div>
        <button class="main-btn copy-btn" onclick="copyFinal()">ìµœì¢… ê²°ê³¼ ë³µì‚¬</button>
    </div>

    <div id="exclude" class="tab-content" style="display:none;">
        <textarea id="excludeText" placeholder="ì œì™¸í•  ì§€ì—­ ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        <button class="main-btn" onclick="extractExclude()">ë™ ì´ë¦„ ì¶”ì¶œ</button>
        <div id="excludeList" style="margin-top:15px;"></div>
        <button class="main-btn" style="background:var(--sub);" onclick="makeExclude()">ì œì™¸ ê²°ê³¼ ìƒì„±</button>
        <div id="excludeBox" class="box"></div>
        <button class="main-btn copy-btn" onclick="copyExclude()">ê²°ê³¼ ë³µì‚¬</button>
    </div>
</div>

<script>
const REST_API_KEY="KakaoAK f0d4cc4d5d27754eef8ea144d7aa9691";
let map, myLat, myLon, currentLat, currentLon, selectMarker;
let markers = [];
let searchGlobal = [];

// [ì´ˆê¸° ì„¤ì • ë³µêµ¬] ì§€ë„ ë° ìœ„ì¹˜ ì´ˆê¸°í™”
function initMap() {
    navigator.geolocation.getCurrentPosition(pos => {
        myLat = pos.coords.latitude;
        myLon = pos.coords.longitude;
        currentLat = myLat; currentLon = myLon;
        const container = document.getElementById('map');
        map = new kakao.maps.Map(container, { center: new kakao.maps.LatLng(myLat, myLon), level: 6 });

        new kakao.maps.Marker({
            position: new kakao.maps.LatLng(myLat, myLon),
            map: map,
            image: new kakao.maps.MarkerImage('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png', new kakao.maps.Size(24, 35))
        });

        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
            let latlng = mouseEvent.latLng;
            currentLat = latlng.getLat(); currentLon = latlng.getLng();
            if(selectMarker) selectMarker.setMap(null);
            selectMarker = new kakao.maps.Marker({ position: latlng });
            selectMarker.setMap(map);
        });
    }, () => {
        map = new kakao.maps.Map(document.getElementById('map'), { center: new kakao.maps.LatLng(35.247, 128.651), level: 6 });
    });
}
kakao.maps.load(initMap);

function goMyLocation(){
    if(myLat) map.setCenter(new kakao.maps.LatLng(myLat, myLon));
}

// [ì´ˆê¸° ì•Œê³ ë¦¬ì¦˜ ë³µêµ¬] ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜
function getDistance(lat1,lon1,lat2,lon2){
    const R=6371;
    const dLat=(lat2-lat1)*Math.PI/180;
    const dLon=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

// [ì´ˆê¸° ì•Œê³ ë¦¬ì¦˜ ë³µêµ¬] ë°˜ê²½ ë‚´ ë™ ê²€ìƒ‰
async function findDongs(){
    markers.forEach(m => m.setMap(null)); markers = [];
    const radius = Number(document.getElementById("radius").value);
    let mapData = new Map();
    const step = 1;
    for(let i=-radius; i<=radius; i+=step){
        for(let j=-radius; j<=radius; j+=step){
            let y = currentLat+(i/111);
            let x = currentLon+(j/(111*Math.cos(currentLat*Math.PI/180)));
            let dist = getDistance(currentLat,currentLon,y,x);
            if(dist > radius) continue;
            try {
                let res = await fetch(`https://dapi.kakao.com/v2/local/geo/coord2regioncode.json?x=${x}&y=${y}`,{headers:{Authorization:REST_API_KEY}});
                let data = await res.json();
                if(data.documents[0]){
                    let d = data.documents[0];
                    let full = `${d.region_1depth_name} ${d.region_2depth_name} ${d.region_3depth_name}`;
                    if(!mapData.has(full) || mapData.get(full).dist > dist) mapData.set(full, {dist, lat:y, lon:x});
                }
            } catch(e){}
        }
    }
    searchGlobal = [...mapData.entries()].sort((a,b)=>a[1].dist-b[1].dist).map(v=>`${v[0]} (${v[1].dist.toFixed(2)}km)`);
    const div = document.getElementById("searchResult");
    div.innerHTML = "";
    [...mapData.entries()].sort((a,b)=>a[1].dist-b[1].dist).forEach(v => {
        let m = new kakao.maps.Marker({ position: new kakao.maps.LatLng(v[1].lat, v[1].lon), map: map });
        markers.push(m);
        div.innerHTML += `<div class="card"><b>${v[0]}</b> <span style="float:right; color:var(--sub);">${v[1].dist.toFixed(2)}km</span></div>`;
    });
}

// ê³µí†µ íƒ­ ì´ë™
function tab(evt, id){
    document.querySelectorAll(".tab-content").forEach(v=>v.style.display="none");
    document.getElementById(id).style.display="block";
    document.querySelectorAll(".tab-button").forEach(b=>b.classList.remove("active"));
    evt.target.classList.add("active");
}

// [ì´ˆê¸° ë¡œì§ ìœ ì§€] ì´ë¦„ ì •ê·œí™” ë° ê·¸ë£¹í™”
function normalizeDong(name){
    let last=name.split(" ").pop();
    if(last.endsWith("ë™")||last.endsWith("ë©´")||last.endsWith("ì")){
        let base=last.slice(0,-1); if(base.length===1)return last; return base;
    }
    return last;
}
function getGroupName(parts){
    if(parts.length>=4 && parts[2].endsWith("êµ¬")) return `${parts[0]} ${parts[1]} ${parts[2]}`;
    return `${parts[0]} ${parts[1]}`;
}
function splitGroups(text){
    let arr=text.split(/[,\n]/).map(v=>v.trim()).filter(v=>v);
    let map={};
    arr.forEach(v=>{
        let clean=v.replace(/\(.+\)/,"").trim();
        let parts=clean.split(" ");
        let group=getGroupName(parts);
        let dong=normalizeDong(clean);
        if(!map[group])map[group]=[]; if(!map[group].includes(dong))map[group].push(dong);
    });
    return map;
}

// ê·¸ë£¹ ë Œë”ë§ ë° ì²´í¬ ë¡œì§
function renderGroup(target, mapData, withMoney){
    const list = document.getElementById(target);
    list.innerHTML = "";
    Object.keys(mapData).forEach((g, idx) => {
        const id = `${target}-g-${idx}`;
        let html = `<div class="group-container" id="${id}">
            <div class="groupHeader">
                <input type="checkbox" onchange="toggleGroup(this, '${id}')"> <span>${g}</span>
            </div>`;
        mapData[g].forEach(d => {
            html += `<div class="row">
                <input type="checkbox" class="dong-check"> <span>${d}</span>
                ${withMoney ? '<input type="number" class="dong-price" placeholder="ê¸ˆì•¡">' : ''}
            </div>`;
        });
        html += `</div>`;
        list.innerHTML += html;
    });
}

function toggleGroup(chk, groupId) {
    document.getElementById(groupId).querySelectorAll(".dong-check").forEach(c => c.checked = chk.checked);
}

function extractAccept(){ renderGroup("acceptList", splitGroups(document.getElementById("acceptText").value), true); }
function extractExclude(){ renderGroup("excludeList", splitGroups(document.getElementById("excludeText").value), false); }

function makeFinal(){
    let res = [];
    document.querySelectorAll("#acceptList .row").forEach(r => {
        if(r.querySelector(".dong-check").checked){
            let name = r.querySelector("span").innerText;
            let money = r.querySelector(".dong-price").value;
            if(money) res.push(`${name}#${money}`);
        }
    });
    document.getElementById("finalBox").innerText = res.join(",");
}

function makeExclude(){
    let res = [];
    document.querySelectorAll("#excludeList .row").forEach(r => {
        if(r.querySelector(".dong-check").checked) res.push(r.querySelector("span").innerText);
    });
    document.getElementById("excludeBox").innerText = res.join(",");
}

function copySearch(){ navigator.clipboard.writeText(searchGlobal.join(",")); alert("ë³µì‚¬ ì™„ë£Œ"); }
function copyFinal(){ navigator.clipboard.writeText(document.getElementById("finalBox").innerText); alert("ë³µì‚¬ ì™„ë£Œ"); }
function copyExclude(){ navigator.clipboard.writeText(document.getElementById("excludeBox").innerText); alert("ë³µì‚¬ ì™„ë£Œ"); }
</script>
</body>
</html>
