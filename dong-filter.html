<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë™ ìë™ í•„í„° ì‹œìŠ¤í…œ V2 FINAL</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c4efd9618689d77a19905c8996d3fe3f"></script>
<style>
    body{font-family:Arial;padding:15px;margin:0; background: #fff;}
    .nav-back { margin-bottom: 10px; }
    .nav-back a { text-decoration: none; color: #00d2ff; font-weight: bold; font-size: 0.9rem; }
    .tabs{display:flex;margin-bottom:15px;}
    .tab-button{flex:1;padding:10px;border:1px solid #ccc;background:#f0f0f0;cursor:pointer;}
    .tab-button.active{background:#ddd;font-weight:bold;}
    textarea{width:100%;height:120px;}
    button{width:100%;padding:10px;margin-top:8px; cursor: pointer;}
    .row{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
    .row input[type=number]{width:80px;}
    .box{border:1px solid #ccc;padding:10px;margin-top:10px;border-radius:6px;}
    .card{border:1px solid #ccc;padding:8px;margin-bottom:6px;border-radius:6px;}
    .smallBtns{display:flex;gap:6px;margin-top:10px;}
    .smallBtns button{width:50%;padding:6px;}
    .groupHeader{display:flex;align-items:center;gap:6px;margin-top:10px;font-weight:bold;}
    .map{width:100%;height:320px;margin-bottom:10px;border:1px solid #ccc;}
    .mapBtn{position:absolute;z-index:5;top:10px;right:10px;background:white;padding:6px;border:1px solid #aaa;cursor:pointer;}
    .mapWrap{position:relative;}
</style>
</head>
<body>

<div class="header-nav"><a href="index.html">â† í¬í„¸</a> <span style="margin-left:15px; font-weight:bold;">ğŸ“ ë™ ìë™ í•„í„° ì‹œìŠ¤í…œ V2 FINAL</span></div>

<div class="tabs">
    <div class="tab-button active" onclick="tab(event,'search')">ê²€ìƒ‰</div>
    <div class="tab-button" onclick="tab(event,'accept')">ìˆ˜ë½</div>
    <div class="tab-button" onclick="tab(event,'exclude')">ì œì™¸</div>
</div>

<div id="search" class="tab-content">
    <div class="mapWrap">
        <div id="map" class="map"></div>
        <div class="mapBtn" onclick="goMyLocation()">ë‚´ ìœ„ì¹˜ë¡œ</div>
    </div>
    <label>ê²€ìƒ‰ ë°˜ê²½</label>
    <select id="radius">
        <option value="1">1km</option>
        <option value="2">2km</option>
        <option value="5" selected>5km</option>
        <option value="10">10km</option>
        <option value="20">20km</option>
        <option value="50">50km</option>
    </select>
    <button onclick="findDongs()">ê²€ìƒ‰í•˜ê¸°</button>
    <button onclick="copySearch()">ê²€ìƒ‰ê²°ê³¼ ë³µì‚¬</button>
    <div id="searchResult"></div>
</div>

<div id="accept" class="tab-content" style="display:none;">
    <textarea id="acceptText"></textarea>
    <button onclick="extractAccept()">ë™ ì´ë¦„ ì¶”ì¶œ</button>
    <div id="acceptList"></div>
    <div class="smallBtns">
        <button onclick="checkAll('acceptList',true)">ì „ì²´ ì„ íƒ</button>
        <button onclick="checkAll('acceptList',false)">ì „ì²´ í•´ì œ</button>
    </div>
    <button onclick="makeFinal()">ìµœì¢… ê²°ê³¼ ìƒì„±</button>
    <div id="finalBox" class="box"></div>
    <button onclick="copyFinal()">ìµœì¢… ê²°ê³¼ ë³µì‚¬</button>
</div>

<div id="exclude" class="tab-content" style="display:none;">
    <textarea id="excludeText"></textarea>
    <button onclick="extractExclude()">ë™ ì´ë¦„ ì¶”ì¶œ</button>
    <div id="excludeList"></div>
    <div class="smallBtns">
        <button onclick="checkAll('excludeList',true)">ì „ì²´ ì„ íƒ</button>
        <button onclick="checkAll('excludeList',false)">ì „ì²´ í•´ì œ</button>
    </div>
    <button onclick="makeExclude()">ì œì™¸ ê²°ê³¼ ìƒì„±</button>
    <div id="excludeBox" class="box"></div>
    <button onclick="copyExclude()">ê²°ê³¼ ë³µì‚¬</button>
</div>

<script>
/* ì‚¬ìš©ìë‹˜ ë¡œì§ ê·¸ëŒ€ë¡œ ìœ ì§€ */
const REST_API_KEY="KakaoAK f0d4cc4d5d27754eef8ea144d7aa9691";
let map;
let myLat,myLon,currentLat,currentLon;
let myMarker,selectMarker;
let markers=[];
let searchGlobal=[];

// ì§€ë„ ì´ˆê¸°í™”
const container = document.getElementById('map');
const options = { center: new kakao.maps.LatLng(35.5384, 129.3114), level: 6 };
map = new kakao.maps.Map(container, options);

navigator.geolocation.getCurrentPosition(pos=>{
    myLat=pos.coords.latitude;
    myLon=pos.coords.longitude;
    currentLat=myLat;
    currentLon=myLon;
    let posi=new kakao.maps.LatLng(myLat,myLon);
    myMarker=new kakao.maps.Marker({
        position:posi,
        image:new kakao.maps.MarkerImage('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png', new kakao.maps.Size(24,35))
    });
    myMarker.setMap(map);
    map.setCenter(posi);
});

kakao.maps.event.addListener(map,'click',function(mouseEvent){
    let latlng=mouseEvent.latLng;
    currentLat=latlng.getLat(); currentLon=latlng.getLng();
    if(selectMarker)selectMarker.setMap(null);
    selectMarker=new kakao.maps.Marker({position:latlng});
    selectMarker.setMap(map);
});

function goMyLocation(){
    currentLat=myLat; currentLon=myLon;
    map.setCenter(new kakao.maps.LatLng(myLat,myLon));
}

function tab(evt,id){
    document.querySelectorAll(".tab-content").forEach(v=>v.style.display="none");
    document.getElementById(id).style.display="block";
    document.querySelectorAll(".tab-button").forEach(b=>b.classList.remove("active"));
    evt.target.classList.add("active");
}

function clearMarkers(){ markers.forEach(m=>m.setMap(null)); markers=[]; }

function getDistance(lat1,lon1,lat2,lon2){
    const R=6371;
    const dLat=(lat2-lat1)*Math.PI/180;
    const dLon=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

async function findDongs(){
    clearMarkers();
    const radius=Number(document.getElementById("radius").value);
    let mapData=new Map();
    const step=1;
    for(let i=-radius;i<=radius;i+=step){
        for(let j=-radius;j<=radius;j+=step){
            let y=currentLat+(i/111);
            let x=currentLon+(j/(111*Math.cos(currentLat*Math.PI/180)));
            let dist=getDistance(currentLat,currentLon,y,x);
            if(dist>radius)continue;
            try{
                let res=await fetch(`https://dapi.kakao.com/v2/local/geo/coord2regioncode.json?x=${x}&y=${y}`,{headers:{Authorization:REST_API_KEY}});
                let data=await res.json();
                if(data.documents[0]){
                    let d=data.documents[0];
                    let full=`${d.region_1depth_name} ${d.region_2depth_name} ${d.region_3depth_name}`;
                    if(!mapData.has(full)||mapData.get(full).dist>dist){
                        mapData.set(full,{dist,lat:y,lon:x});
                    }
                }
            }catch(e){}
        }
    }
    searchGlobal=[...mapData.entries()].sort((a,b)=>a[1].dist-b[1].dist).map(v=>`${v[0]} (${v[1].dist.toFixed(2)}km)`);
    let div=document.getElementById("searchResult");
    div.innerHTML="";
    [...mapData.entries()].sort((a,b)=>a[1].dist-b[1].dist).forEach(v=>{
        let pos=new kakao.maps.LatLng(v[1].lat,v[1].lon);
        let marker=new kakao.maps.Marker({position:pos});
        marker.setMap(map);
        markers.push(marker);
        div.innerHTML+=`<div class="card">${v[0]} (${v[1].dist.toFixed(2)}km)</div>`;
    });
}

function copySearch(){ navigator.clipboard.writeText(searchGlobal.join(",")); alert("ë³µì‚¬ ì™„ë£Œ"); }
function normalizeDong(name){
    let last=name.split(" ").pop();
    if(last.endsWith("ë™")||last.endsWith("ë©´")||last.endsWith("ì")){
        let base=last.slice(0,-1); if(base.length===1)return last; return base;
    }
    return last;
}
function getGroupName(parts){
    if(parts.length>=4){
        if(parts[2].endsWith("êµ¬")) return `${parts[0]} ${parts[1]} ${parts[2]}`;
        return `${parts[0]} ${parts[1]}`;
    }
    if(parts.length===3){
        if(parts[1].endsWith("êµ¬")) return `${parts[0]} ${parts[1]}`;
        return `${parts[0]} ${parts[1]}`;
    }
    return parts.join(" ");
}
function splitGroups(text){
    let arr=text.split(",").map(v=>v.trim()).filter(v=>v);
    let map={};
    arr.forEach(v=>{
        let clean=v.replace(/\(.+\)/,"").trim();
        let parts=clean.split(" ");
        let group=getGroupName(parts);
        let dong=normalizeDong(clean);
        if(!map[group])map[group]=[]; if(!map[group].includes(dong))map[group].push(dong);
    });
    return map;
}
function checkAll(id,state){ document.querySelectorAll(`#${id} input[type=checkbox]`).forEach(c=>c.checked=state); }
function toggleGroup(header){
    let group=header.parentElement.parentElement;
    group.querySelectorAll(".row input[type=checkbox]").forEach(c=>c.checked=header.checked);
}
function renderGroup(target,mapData,withMoney){
    let div=document.getElementById(target);
    div.innerHTML="";
    Object.keys(mapData).forEach(g=>{
        div.innerHTML+=`<div><div class="groupHeader"><input type="checkbox" onchange="toggleGroup(this)"><span>${g}</span></div></div>`;
        mapData[g].forEach(d=>{
            div.innerHTML+=`<div class="row"><input type="checkbox"><span>${d}</span>${withMoney?'<input type="number" placeholder="ê¸ˆì•¡">':""}</div>`;
        });
    });
}
function extractAccept(){ renderGroup("acceptList",splitGroups(document.getElementById("acceptText").value),true); }
function extractExclude(){ renderGroup("excludeList",splitGroups(document.getElementById("excludeText").value),false); }
function makeFinal(){
    let rows=document.querySelectorAll("#acceptList .row");
    let out=[];
    rows.forEach(r=>{
        if(r.querySelector("input[type=checkbox]").checked){
            let name=r.querySelector("span").innerText;
            let money=r.querySelector("input[type=number]").value;
            if(money)out.push(name+"#"+money);
        }
    });
    document.getElementById("finalBox").innerText=out.join(",");
}
function copyFinal(){ navigator.clipboard.writeText(document.getElementById("finalBox").innerText); alert("ë³µì‚¬ ì™„ë£Œ"); }
function makeExclude(){
    let rows=document.querySelectorAll("#excludeList .row");
    let out=[];
    rows.forEach(r=>{ if(r.querySelector("input").checked) out.push(r.querySelector("span").innerText); });
    document.getElementById("excludeBox").innerText=out.join(",");
}
function copyExclude(){ navigator.clipboard.writeText(document.getElementById("excludeBox").innerText); alert("ë³µì‚¬ ì™„ë£Œ"); }
</script>
</body>

</html>


