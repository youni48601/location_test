<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë™ ìë™ í•„í„° ì‹œìŠ¤í…œ V2 FINAL</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c4efd9618689d77a19905c8996d3fe3f&libraries=services"></script>
<style>
    :root { --primary: #00d2ff; --sub: #007bff; --bg: #f4f7f6; }
    body { font-family: 'Pretendard', sans-serif; padding: 0; margin: 0; background: var(--bg); color: #333; }
    
    /* ìƒë‹¨ ë‚´ë¹„ê²Œì´ì…˜ ë°” - transport.html ìŠ¤íƒ€ì¼ê³¼ í†µì¼ */
    .header-nav { 
        background: #fff; padding: 15px; display: flex; align-items: center; 
        border-bottom: 1px solid #ddd; position: sticky; top:0; z-index:100; 
    }
    .header-nav a { 
        text-decoration: none; color: var(--sub); font-weight: bold; 
        border: 1px solid var(--sub); padding: 4px 10px; border-radius: 5px; 
    }

    .main-container { padding: 15px; }

    /* íƒ­ ìŠ¤íƒ€ì¼ ê°œì„  */
    .tabs { display: flex; margin-bottom: 15px; background: #eee; border-radius: 10px; padding: 5px; }
    .tab-button { 
        flex: 1; padding: 12px; border: none; background: none; 
        cursor: pointer; border-radius: 8px; transition: 0.3s; font-weight: bold; color: #666;
    }
    .tab-button.active { background: white; color: var(--sub); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

    /* ì§€ë„ ì˜ì—­ */
    .mapWrap { position: relative; border-radius: 15px; overflow: hidden; border: 1px solid #ddd; margin-bottom: 15px; }
    .map { width: 100%; height: 350px; }
    .mapBtn { 
        position: absolute; z-index: 5; top: 10px; right: 10px; 
        background: white; padding: 8px 12px; border: 1px solid #aaa; 
        border-radius: 8px; cursor: pointer; font-size: 0.8rem; font-weight: bold;
    }

    /* ì…ë ¥ ë° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    textarea { width: 100%; height: 120px; border-radius: 10px; border: 1px solid #ddd; padding: 10px; box-sizing: border-box; }
    select, .main-btn { 
        width: 100%; padding: 15px; margin-top: 10px; border-radius: 10px; 
        border: 1px solid #ddd; font-size: 1rem; 
    }
    .main-btn { 
        background: var(--primary); color: white; border: none; 
        font-weight: bold; cursor: pointer; transition: 0.2s; 
    }
    .main-btn:active { transform: scale(0.98); background: var(--sub); }
    .copy-btn { background: #6c757d; margin-top: 5px; }

    /* ê²°ê³¼ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .box { border: 1px solid #ddd; padding: 15px; margin-top: 10px; border-radius: 12px; background: white; min-height: 50px; word-break: break-all; }
    .card { border: 1px solid #eee; padding: 10px; margin-bottom: 8px; border-radius: 10px; background: white; font-size: 0.9rem; }
    .row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; background: white; padding: 8px; border-radius: 8px; border: 1px solid #f0f0f0; }
    .row input[type=number] { width: 70px; padding: 5px; border-radius: 5px; border: 1px solid #ddd; }
    
    .smallBtns { display: flex; gap: 8px; margin-top: 10px; }
    .smallBtns button { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    .groupHeader { display: flex; align-items: center; gap: 8px; margin-top: 15px; font-weight: bold; color: var(--sub); }
</style>
</head>
<body>

<div class="header-nav">
    <a href="index.html">ğŸ  í¬í„¸ë¡œ</a> 
    <span style="margin-left:15px; font-weight:bold;">ë™ ìë™ í•„í„° ì‹œìŠ¤í…œ</span>
</div>

<div class="main-container">
    <div class="tabs">
        <div class="tab-button active" onclick="tab(event,'search')">ê²€ìƒ‰</div>
        <div class="tab-button" onclick="tab(event,'accept')">ìˆ˜ë½</div>
        <div class="tab-button" onclick="tab(event,'exclude')">ì œì™¸</div>
    </div>

    <div id="search" class="tab-content">
        <div class="mapWrap">
            <div id="map" class="map"></div>
            <div class="mapBtn" onclick="goMyLocation()">ë‚´ ìœ„ì¹˜ë¡œ</div>
        </div>
        <label style="font-size: 0.85rem; color: #666;">ê²€ìƒ‰ ë°˜ê²½ ì„¤ì •</label>
        <select id="radius">
            <option value="1">1km ì´ë‚´</option>
            <option value="2">2km ì´ë‚´</option>
            <option value="5" selected>5km ì´ë‚´</option>
            <option value="10">10km ì´ë‚´</option>
            <option value="20">20km ì´ë‚´</option>
            <option value="50">50km ì´ë‚´</option>
        </select>
        <button class="main-btn" onclick="findDongs()">ë°˜ê²½ ë‚´ ë™ ê²€ìƒ‰í•˜ê¸°</button>
        <button class="main-btn copy-btn" onclick="copySearch()">ê²°ê³¼ ì „ì²´ ë³µì‚¬</button>
        <div id="searchResult" style="margin-top:15px;"></div>
    </div>

    <div id="accept" class="tab-content" style="display:none;">
        <textarea id="acceptText" placeholder="ì—¬ê¸°ì— ì£¼ì†Œ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
        <button class="main-btn" onclick="extractAccept()">ë™ ì´ë¦„ ì¶”ì¶œ</button>
        <div id="acceptList"></div>
        <div class="smallBtns">
            <button onclick="checkAll('acceptList',true)">ì „ì²´ ì„ íƒ</button>
            <button onclick="checkAll('acceptList',false)">ì „ì²´ í•´ì œ</button>
        </div>
        <button class="main-btn" style="background:var(--sub);" onclick="makeFinal()">ìµœì¢… ê²°ê³¼ ìƒì„± (#)</button>
        <div id="finalBox" class="box"></div>
        <button class="main-btn copy-btn" onclick="copyFinal()">ìµœì¢… ê²°ê³¼ ë³µì‚¬</button>
    </div>

    <div id="exclude" class="tab-content" style="display:none;">
        <textarea id="excludeText" placeholder="ì œì™¸í•  ì§€ì—­ ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        <button class="main-btn" onclick="extractExclude()">ë™ ì´ë¦„ ì¶”ì¶œ</button>
        <div id="excludeList"></div>
        <div class="smallBtns">
            <button onclick="checkAll('excludeList',true)">ì „ì²´ ì„ íƒ</button>
            <button onclick="checkAll('excludeList',false)">ì „ì²´ í•´ì œ</button>
        </div>
        <button class="main-btn" style="background:var(--sub);" onclick="makeExclude()">ì œì™¸ ê²°ê³¼ ìƒì„±</button>
        <div id="excludeBox" class="box"></div>
        <button class="main-btn copy-btn" onclick="copyExclude()">ê²°ê³¼ ë³µì‚¬</button>
    </div>
</div>

<script>
/* ë¡œì§ì€ ì‚¬ìš©ìë‹˜ì˜ ì›ë³¸ì„ ìœ ì§€í•˜ë©° ì§€ë„ ì´ˆê¸°í™” ë¶€ë¶„ë§Œ ë³´ê°•í–ˆìŠµë‹ˆë‹¤. */
const REST_API_KEY="KakaoAK f0d4cc4d5d27754eef8ea144d7aa9691";
let map, ps;
let myLat, myLon, currentLat, currentLon;
let myMarker, selectMarker;
let markers = [];
let searchGlobal = [];

function initMap() {
    navigator.geolocation.getCurrentPosition(pos => {
        myLat = pos.coords.latitude;
        myLon = pos.coords.longitude;
        currentLat = myLat; currentLon = myLon;
        
        const container = document.getElementById('map');
        const options = { center: new kakao.maps.LatLng(myLat, myLon), level: 6 };
        map = new kakao.maps.Map(container, options);

        myMarker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(myLat, myLon),
            map: map,
            image: new kakao.maps.MarkerImage('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png', new kakao.maps.Size(24, 35))
        });

        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
            let latlng = mouseEvent.latLng;
            currentLat = latlng.getLat(); currentLon = latlng.getLng();
            if(selectMarker) selectMarker.setMap(null);
            selectMarker = new kakao.maps.Marker({ position: latlng });
            selectMarker.setMap(map);
        });
    }, err => {
        // GPS ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì¢Œí‘œ (ì°½ì›)
        map = new kakao.maps.Map(document.getElementById('map'), { center: new kakao.maps.LatLng(35.247, 128.651), level: 6 });
    });
}

kakao.maps.load(initMap);

function goMyLocation(){
    if(myLat && myLon) {
        currentLat = myLat; currentLon = myLon;
        map.setCenter(new kakao.maps.LatLng(myLat, myLon));
    }
}

function tab(evt, id){
    document.querySelectorAll(".tab-content").forEach(v=>v.style.display="none");
    document.getElementById(id).style.display="block";
    document.querySelectorAll(".tab-button").forEach(b=>b.classList.remove("active"));
    evt.target.classList.add("active");
}

function clearMarkers(){ markers.forEach(m=>m.setMap(null)); markers=[]; }

function getDistance(lat1,lon1,lat2,lon2){
    const R=6371;
    const dLat=(lat2-lat1)*Math.PI/180;
    const dLon=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

async function findDongs(){
    clearMarkers();
    const radius=Number(document.getElementById("radius").value);
    let mapData=new Map();
    const step=1;
    for(let i=-radius;i<=radius;i+=step){
        for(let j=-radius;j<=radius;j+=step){
            let y=currentLat+(i/111);
            let x=currentLon+(j/(111*Math.cos(currentLat*Math.PI/180)));
            let dist=getDistance(currentLat,currentLon,y,x);
            if(dist>radius)continue;
            try{
                let res=await fetch(`https://dapi.kakao.com/v2/local/geo/coord2regioncode.json?x=${x}&y=${y}`,{headers:{Authorization:REST_API_KEY}});
                let data=await res.json();
                if(data.documents[0]){
                    let d=data.documents[0];
                    let full=`${d.region_1depth_name} ${d.region_2depth_name} ${d.region_3depth_name}`;
                    if(!mapData.has(full)||mapData.get(full).dist>dist){
                        mapData.set(full,{dist,lat:y,lon:x});
                    }
                }
            }catch(e){}
        }
    }
    searchGlobal=[...mapData.entries()].sort((a,b)=>a[1].dist-b[1].dist).map(v=>`${v[0]} (${v[1].dist.toFixed(2)}km)`);
    let div=document.getElementById("searchResult");
    div.innerHTML="";
    [...mapData.entries()].sort((a,b)=>a[1].dist-b[1].dist).forEach(v=>{
        let pos=new kakao.maps.LatLng(v[1].lat,v[1].lon);
        let marker=new kakao.maps.Marker({position:pos});
        marker.setMap(map);
        markers.push(marker);
        div.innerHTML+=`<div class="card"><b>${v[0]}</b> <span style="color:var(--sub); float:right;">${v[1].dist.toFixed(2)}km</span></div>`;
    });
}

function copySearch(){ navigator.clipboard.writeText(searchGlobal.join(",")); alert("ë³µì‚¬ ì™„ë£Œ"); }

function normalizeDong(name){
    let last=name.split(" ").pop();
    if(last.endsWith("ë™")||last.endsWith("ë©´")||last.endsWith("ì")){
        let base=last.slice(0,-1); if(base.length===1)return last; return base;
    }
    return last;
}

function getGroupName(parts){
    if(parts.length>=4){
        if(parts[2].endsWith("êµ¬")) return `${parts[0]} ${parts[1]} ${parts[2]}`;
        return `${parts[0]} ${parts[1]}`;
    }
    if(parts.length===3){
        if(parts[1].endsWith("êµ¬")) return `${parts[0]} ${parts[1]}`;
        return `${parts[0]} ${parts[1]}`;
    }
    return parts.join(" ");
}

function splitGroups(text){
    let arr=text.split(",").map(v=>v.trim()).filter(v=>v);
    let map={};
    arr.forEach(v=>{
        let clean=v.replace(/\(.+\)/,"").trim();
        let parts=clean.split(" ");
        let group=getGroupName(parts);
        let dong=normalizeDong(clean);
        if(!map[group])map[group]=[]; if(!map[group].includes(dong))map[group].push(dong);
    });
    return map;
}

function checkAll(id,state){ document.querySelectorAll(`#${id} input[type=checkbox]`).forEach(c=>c.checked=state); }

function toggleGroup(header){
    let group=header.parentElement.parentElement;
    group.querySelectorAll(".row input[type=checkbox]").forEach(c=>c.checked=header.checked);
}

function renderGroup(target,mapData,withMoney){
    let div=document.getElementById(target);
    div.innerHTML="";
    Object.keys(mapData).forEach(g=>{
        div.innerHTML+=`<div><div class="groupHeader"><input type="checkbox" onchange="toggleGroup(this)"><span>${g}</span></div></div>`;
        mapData[g].forEach(d=>{
            div.innerHTML+=`<div class="row"><input type="checkbox"><span>${d}</span>${withMoney?'<input type="number" placeholder="ê¸ˆì•¡">':""}</div>`;
        });
    });
}

function extractAccept(){ renderGroup("acceptList",splitGroups(document.getElementById("acceptText").value),true); }
function extractExclude(){ renderGroup("excludeList",splitGroups(document.getElementById("excludeText").value),false); }

function makeFinal(){
    let rows=document.querySelectorAll("#acceptList .row");
    let out=[];
    rows.forEach(r=>{
        if(r.querySelector("input[type=checkbox]").checked){
            let name=r.querySelector("span").innerText;
            let money=r.querySelector("input[type=number]").value;
            if(money)out.push(name+"#"+money);
        }
    });
    document.getElementById("finalBox").innerText=out.join(",");
}

function copyFinal(){ navigator.clipboard.writeText(document.getElementById("finalBox").innerText); alert("ë³µì‚¬ ì™„ë£Œ"); }

function makeExclude(){
    let rows=document.querySelectorAll("#excludeList .row");
    let out=[];
    rows.forEach(r=>{ if(r.querySelector("input").checked) out.push(r.querySelector("span").innerText); });
    document.getElementById("excludeBox").innerText=out.join(",");
}

function copyExclude(){ navigator.clipboard.writeText(document.getElementById("excludeBox").innerText); alert("ë³µì‚¬ ì™„ë£Œ"); }
</script>
</body>
</html>
